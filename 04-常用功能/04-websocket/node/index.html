<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>

<button onclick="sendMsg();">发送数据</button>
<script>
var ws=new WebSocket("ws://127.0.0.1:8000");

/**
 * 【 readyState 】
 * CONNECTING：值为0，表示正在连接
 * OPEN：值为1，表示连接成功，可以通信了
 * CLOSING：值为2，表示连接正在关闭
 * CLOSED：值为3，表示连接已经关闭，或者打开连接失败
 */
// switch (ws.readyState) {
//   case WebSocket.CONNECTING:
//     // do something
//     break;
//   case WebSocket.OPEN:
//     // do something
//     break;
//   case WebSocket.CLOSING:
//     // do something
//     break;
//   case WebSocket.CLOSED:
//     // do something
//     break;
//   default:
//     // this never happens
//     break;
// }

/**
 * 【 API 】
 */
// ws.addEventListener('open', function (event) {
// 	ws.send('Hello Server!');
// });
ws.onopen=function(event){
	console.log("Connection open ..."); 
	// ws.send("Hello WebSockets!");
};

ws.onmessage = function(event) {
	if(typeof event.data === String) {
		console.log("Received data string: " + event.data);
	}
	if(event.data instanceof ArrayBuffer){
		var buffer = event.data;
		console.log("Received arraybuffer: " + buffer);
	}
	ws.close();
};
// 可以使用binaryType属性，显式指定收到的二进制数据类型
/*
// 收到的是 blob 数据
ws.binaryType = "blob";
ws.onmessage = function(e) {
	console.log(e.data.size);
};
// 收到的是 ArrayBuffer 数据
ws.binaryType = "arraybuffer";
ws.onmessage = function(e) {
	console.log(e.data.byteLength);
};
*/

ws.onclose = function(event) {
	var code = event.code;
	var reason = event.reason;
	var wasClean = event.wasClean;
	console.log("Connection closed ...");
};

ws.onerror=function(e){
	console.log(e);
};

function sendMsg(){
	/**
	 * 1.发送文本
	 */
	ws.send('send text');
	/**
	 * 2.发送 Blob 对象
	 */
	// var file = document.querySelector('input[type="file"]').files[0];
	// ws.send(file);
	/**
	 * 3.发送 ArrayBuffer 对象
	 * Sending canvas ImageData as ArrayBuffer
	 * 实例对象的bufferedAmount属性，表示还有多少字节的二进制数据没有发送出去，可以用来判断发送是否结束
	 */
	// var img = canvas_context.getImageData(0, 0, 400, 320);
	// var binary = new Uint8Array(img.data.length);
	// for (var i = 0; i < img.data.length; i++) {
	// 	binary[i] = img.data[i];
	// }
	// ws.send(binary.buffer);

	// var data = new ArrayBuffer(10000000);
	// socket.send(data);
	// if (socket.bufferedAmount === 0) {
	// 	// 发送完毕
	// } else {
	// 	// 发送还没结束
	// }
}
</script>
</body>
</html>